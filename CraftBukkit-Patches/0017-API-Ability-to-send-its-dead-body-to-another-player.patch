From 73fb821950ead69bc21cb4370ad6b6078c8d03b1 Mon Sep 17 00:00:00 2001
From: libhalt <libhalt@libhalt.net>
Date: Sat, 30 Aug 2014 14:38:24 +0900
Subject: [PATCH] API: Ability to send its dead body to another player


diff --git a/src/main/java/net/minecraft/server/PacketPlayOutNamedEntitySpawn.java b/src/main/java/net/minecraft/server/PacketPlayOutNamedEntitySpawn.java
index ecc28be..0e57496 100644
--- a/src/main/java/net/minecraft/server/PacketPlayOutNamedEntitySpawn.java
+++ b/src/main/java/net/minecraft/server/PacketPlayOutNamedEntitySpawn.java
@@ -11,7 +11,7 @@ import java.io.IOException; // CraftBukkit
 
 public class PacketPlayOutNamedEntitySpawn extends Packet {
 
-    private int a;
+    public int a;//Kyoka
     private GameProfile b;
     private int c;
     private int d;
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 4a898da..1fe1b99 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -52,6 +52,7 @@ import org.bukkit.map.MapView;
 import org.bukkit.metadata.MetadataValue;
 import org.bukkit.plugin.Plugin;
 import org.bukkit.plugin.messaging.StandardMessenger;
+import org.bukkit.scheduler.BukkitRunnable;
 import org.bukkit.scoreboard.Scoreboard;
 import org.bukkit.util.Vector;
 
@@ -1322,6 +1323,9 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
 
     // Kyoka start
     private final CraftPlayer craftPlayer = this;
+    private static int entityId = 12041213;
+    private static DataWatcher DEATH_DATA_WATCHER = getDeathDataWatcher();
+
     private final Kyoka kyoka = new Kyoka() {
         @Override
         public String getLocale() {
@@ -1406,6 +1410,26 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
             getHandle().playerConnection.sendPacket(packetEntityMeta);
         }
 
+        @Override
+        public void dropDeadBodyCopy(Player viewer , Plugin plugin) {
+            int id = entityId++;
+            final EntityPlayer viewingEntityPlayer = ((CraftPlayer)viewer).getHandle();
+            final PacketPlayOutEntityDestroy packetEntityDestroy = new PacketPlayOutEntityDestroy(id);
+            PacketPlayOutEntityMetadata packetEntityMetaData = new PacketPlayOutEntityMetadata(id , DEATH_DATA_WATCHER , true);
+            PacketPlayOutNamedEntitySpawn packetNamedEntitySpawn = new PacketPlayOutNamedEntitySpawn(getHandle());
+            packetNamedEntitySpawn.a = id;
+            viewingEntityPlayer.playerConnection.sendPacket(packetNamedEntitySpawn);
+            viewingEntityPlayer.playerConnection.sendPacket(packetEntityMetaData);
+            new BukkitRunnable(){
+                @Override
+                public void run() {
+                    if(!viewingEntityPlayer.playerConnection.isDisconnected()){
+                        viewingEntityPlayer.playerConnection.sendPacket(packetEntityDestroy);
+                    }
+                }
+            }.runTaskLater(plugin , 100);
+        }
+
         private DataWatcher getEnderDragonDataWatcher(String text, float value){
             //Why? using wrapper class CLARIFY which object we are using and wont use wrong object due to ambiguous Object Parameter
             DataWatcher watcher = new DataWatcher(null);
@@ -1419,6 +1443,20 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         }
     };
 
+    private static DataWatcher getDeathDataWatcher() {
+        DataWatcher watcher = new DataWatcher(null);
+        watcher.a(0, Byte.valueOf((byte) 0));
+        watcher.a(1, Short.valueOf((short) 300));
+        watcher.a(6, Float.valueOf(0.0F));
+        watcher.a(7, Integer.valueOf(0));
+        watcher.a(8, Byte.valueOf((byte) 1));
+        watcher.a(9, Byte.valueOf((byte) 0));
+        watcher.a(16, Byte.valueOf((byte) 0));
+        watcher.a(17, Float.valueOf(0.0F));
+        watcher.a(18, Integer.valueOf(0));
+        return watcher;
+    }
+
     public Kyoka kyoka() {
         return kyoka;
     }
-- 
1.9.1

